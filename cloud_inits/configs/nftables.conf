flush ruleset
table inet filter {
  chain input {
    type filter hook input priority 0;
    policy accept;
  }
  chain forward {
    type filter hook forward priority 0;
    policy drop;

    # Established / related
    ct state established,related accept

    # ForcAD -> any team VM (checker traffic)
    ip saddr 10.10.10.10 ip daddr 10.58.57.0/24 accept

    # Team VMs -> ForcAD (service traffic)
    ip saddr 10.58.57.0/24 ip daddr 10.10.10.10 accept

    # Team VMs -> other team VMs (attack traffic through GW)
    ip saddr 10.58.57.0/24 ip daddr 10.58.57.0/24 accept

    # WG players -> team VMs (all teams, A/D CTF)
    ip saddr 10.57.0.0/16 ip daddr 10.58.57.0/24 accept

    # WG players -> ForcAD scoreboard
    ip saddr 10.57.0.0/16 ip daddr 10.10.10.10 accept

    # WG admins (10.10.10.2-9) -> team VMs + ForcAD
    ip saddr 10.10.10.0/29 ip daddr 10.58.57.0/24 accept
    ip saddr 10.10.10.0/29 ip daddr 10.10.10.10 accept

    # Team VMs -> internet (through GW)
    ip saddr 10.58.57.0/24 oifname "ens19" accept

    # ForcAD -> internet
    ip saddr 10.10.10.10 oifname "ens19" accept
  }
}
table inet nat {
  chain postrouting {
    type nat hook postrouting priority srcnat;

    # Internet access — masquerade to external IP
    oifname "ens19" masquerade

    # All traffic to team VMs — masquerade to GW-side /31 address
    # so team VMs always see their gateway as the source
    ip daddr 10.58.57.0/24 masquerade

    # Traffic to ForcAD — masquerade so ForcAD sees GW IP
    ip daddr 10.10.10.10 masquerade
  }
}
